name: Deploy to VPS

on:
  push:
    branches: [main]
  workflow_dispatch:

concurrency:
  group: deploy-vps
  cancel-in-progress: true

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: production
    if: github.ref == 'refs/heads/main'
    steps:
      - name: Deploy on VPS
        uses: appleboy/ssh-action@029f5b4aeeeb58fdfe1410a5d17f967dacf36262
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          password: ${{ secrets.SSH_PASSWORD }}
          script: |
            set -e
            mkdir -p ~/backups
            if [ ! -d ~/app/.git ]; then
              git clone --branch main https://github.com/${{ github.repository }}.git ~/app
            fi
            cd ~/app
            COMPOSE_CMD="docker compose -p app -f docker-compose.production.yaml"
            $COMPOSE_CMD up -d
            $COMPOSE_CMD exec -T pgsql sh -c 'pg_dump -U $POSTGRES_USER $POSTGRES_DB' > ~/backups/backup-$(date +%Y%m%d-%H%M%S).sql
            find ~/backups -name 'backup-*.sql' -mtime +7 -delete
            git fetch origin main && git checkout ${{ github.sha }}
            $COMPOSE_CMD build --no-cache app
            $COMPOSE_CMD stop app nginx
            $COMPOSE_CMD rm -f app nginx
            docker volume ls -q --filter name=app_app_code | xargs -r docker volume rm || true
            $COMPOSE_CMD up -d
            $COMPOSE_CMD exec -T app php artisan migrate --force
